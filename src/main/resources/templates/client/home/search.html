<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>K·∫øt qu·∫£ t√¨m ki·∫øm</title>

    <link th:href="@{/client/css/home/index.css}" rel="stylesheet" />
    <link rel="stylesheet" href="/client/css/home/search.css">
  </head>

  <body>
    <div class="topbar">
      Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë∆°n t·ª´ 599k ‚Ä¢ ƒê·ªïi size trong 7 ng√†y ‚Ä¢ Hotline: 0988 888 888
    </div>

    <!-- ====== HEADER (COPY NGUY√äN T·ª™ index.html) ====== -->
    <header>
      <div class="header-inner">
        <a class="logo" href="/" aria-label="Trang ch·ªß"
          style="display: flex; align-items: center; text-decoration: none;">
          <img th:src="@{/client/images/logo.png}" 
               alt="Lowtech Store Logo"
               style="height: 40px; width: 40px; border-radius: 50%; object-fit: cover;" />
          <span style="font-size: 16px; font-weight: bold; margin-left: 10px; color: #000;">
              Lowtech Store
          </span>
        </a>

        <div class="search" role="search">
          <svg width="18" height="18" ...>
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg>

          <input id="searchInput" placeholder="T√¨m gi√†y, √°o ƒë·∫•u, ph·ª• ki·ªán‚Ä¶ (v√≠ d·ª•: futsal, mercurial)" />
          <div id="searchResult" class="search-result"></div>

          <button class="btn-primary" id="searchBtn">T√¨m</button>
        </div>

        <div class="header-actions">
          <div class="hotline">üìû 0988 888 888</div>

          <a href="/cart" class="icon-btn">
            <svg
    width="18"
    height="18"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    aria-hidden="true"
  >
    <circle cx="9" cy="21" r="1"></circle>
    <circle cx="20" cy="21" r="1"></circle>
    <path
      d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"
    ></path>
  </svg>
          </a>

          <div id="loginBtn" class="login-icon">
            <img src="https://th.bing.com/th/id/R.f58bd7f73934e1145c97570943087ec6?rik=41HmRGohn%2fnBJg&riu=http%3a%2f%2fwww.acsoft.vn%3a8081%2fresources%2fimages%2favatar.jpg&ehk=4oftGWjeo8XsGu%2fcHG2dUJubsKryVLuNa58H9D3TNKA%3d&risl=&pid=ImgRaw&r=0"
              alt="user" />
            <span class="notify-dot"></span>
          </div>
        </div>
      </div>

      <nav class="nav">
        <div class="nav-inner">
          <div class="dropdown">
              <a href="#" id="tatCaBtn">T·∫§T C·∫¢</a>
              <ul id="tatCaList" class="dropdown-content"></ul>
          </div>

          <div class="dropdown">
              <a href="#" id="thuongHieuBtn">TH∆Ø∆†NG HI·ªÜU</a>
              <ul id="thuongHieuList" class="dropdown-content"></ul>
          </div>

          <div class="dropdown">
              <a href="#" id="monTheThaoBtn">M√îN TH·ªÇ THAO</a>
              <ul id="monTheThaoList" class="dropdown-content"></ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- ====== B·ªé HERO - KH√îNG COPY ====== -->

    <!-- ====== TOOLBAR gi·ªØ nguy√™n ====== -->
    <div class="toolbar" id="toolbar">
      <div class="filters">
        <button class="chip active" id="allBtn">T·∫•t c·∫£</button>
        <select class="chip" id="filterBrand"><option value="">Th∆∞∆°ng hi·ªáu</option></select>
        <select class="chip" id="filterSport"><option value="">M√¥n th·ªÉ thao</option></select>
        <select class="chip" id="filterPrice">
          <option value="">Kho·∫£ng gi√°</option>
          <option value="0-500000">D∆∞·ªõi 500K</option>
          <option value="500000-1000000">500K - 1 tri·ªáu</option>
          <option value="1000000-2000000">1 - 2 tri·ªáu</option>
          <option value="2000000-99999999">Tr√™n 2 tri·ªáu</option>
        </select>
      </div>

      <select class="sort" id="sortSelect">
        <option value="popular">Ph·ªï bi·∫øn</option>
        <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
        <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
        <option value="newest">M·ªõi nh·∫•t</option>
      </select>
    </div>

    <!-- ====== K·∫æT QU·∫¢ T√åM KI·∫æM ====== -->
    <section class="product-section">
      <h2 class="section-title">
        K·∫øt qu·∫£ t√¨m ki·∫øm cho: <span id="keyword"></span>
      </h2>

      <div id="searchResultList" class="product-grid"></div>
    </section>

    <!-- ====== FOOTER gi·ªØ nguy√™n ====== -->
    <footer>
      <div class="footer-inner">
        <div class="ft-col">
          <h4>LT SPORT STORE</h4>
          <p>H·ªá th·ªëng c·ª≠a h√†ng ƒë·ªì th·ªÉ thao ‚Ä¶</p>
          <div class="newsletter">
            <input placeholder="Nh·∫≠p email ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i" />
            <button class="btn-primary">ƒêƒÉng k√Ω</button>
          </div>
        </div>

        <div class="ft-col">
          <h4>Li√™n h·ªá</h4>
          <p>Hotline: 0988 888 888<br>Email: support@LTStore.vn</p>
        </div>

        <div class="ft-col">
          <h4>Ch√≠nh s√°ch</h4>
          <p>Giao h√†ng & ƒê·ªïi tr·∫£<br>B·∫£o h√†nh ‚Ä¶</p>
        </div>
      </div>
    </footer>

    <!-- ====== SCRIPT GI·ªÆ NGUY√äN ====== -->
    <script th:src="@{/client/js/home/index.js}" defer></script>
    <script src="/client/js/home/search.js"></script>

    <script>
document.addEventListener("DOMContentLoaded", async function () {
    try {
        const response = await fetch('/api/auth/me');

        if (response.ok) {
            const user = await response.json();

            const username = user.tenDangNhap || user.username || user.ten_dang_nhap;
            const hoTen = user.hoTen || user.ho_ten;

            if (!hoTen) {
                console.error("Kh√¥ng t√¨m th·∫•y hoTen...");
                sessionStorage.clear();
                renderLoginButton();
                return;
            }

            sessionStorage.setItem("username", username);
            sessionStorage.setItem("ho_ten", hoTen);

            renderUserMenu(hoTen);

        } else {
            sessionStorage.clear();
            renderLoginButton();
        }

    } catch (error) {
        console.error("Kh√¥ng th·ªÉ k·∫øt n·ªëi server:", error);
        sessionStorage.clear();
        renderLoginButton();
    }
});

function renderUserMenu(hoTen) {
    const loginBtn = document.getElementById("loginBtn");
    if (!loginBtn) return;

    loginBtn.outerHTML = `
<div class="user-menu-container">
 <div id="userMenuTrigger" class="user-menu-trigger">
 <span>üë§ Xin ch√†o, <strong>${hoTen}</strong></span>
 <span class="dropdown-arrow">‚ñº</span>
 </div>
 <div id="userDropdownMenu" class="dropdown-menu">
 <a href="/profile">Th√¥ng tin c√° nh√¢n</a>
 <a href="/cart">Gi·ªè h√†ng</a>
 <a href="/order">ƒê∆°n h√†ng</a>
 <a href="#" id="logoutBtn">ƒêƒÉng xu·∫•t</a>
 </div>
</div>`;

    addMenuListeners();
}

function renderLoginButton() {
    const menuContainer = document.querySelector(".user-menu-container");
    if (menuContainer) {
        menuContainer.outerHTML = `
        <div id="loginBtn" class="login-icon">
            <img src="https://th.bing.com/th/id/R.f58bd7f73934e1145c97570943087ec6?rik=41HmRGohn%2fnBJg... alt="user"/>
            <span class="notify-dot"></span>
        </div>`;
    }
    
    const loginBtn = document.getElementById("loginBtn");
    if(loginBtn) {
        loginBtn.addEventListener("click", () => {
            window.location.href = "/login";
        });
    }
}

function addMenuListeners() {
    const menuTrigger = document.getElementById("userMenuTrigger");
    const dropdownMenu = document.getElementById("userDropdownMenu");
    const logoutBtn = document.getElementById("logoutBtn");

    if (menuTrigger && dropdownMenu) {
        menuTrigger.addEventListener("click", (event) => {
            event.stopPropagation();
            dropdownMenu.classList.toggle("show");
        });
    }

    window.addEventListener("click", (e) => {
        if (menuTrigger && dropdownMenu && dropdownMenu.classList.contains("show") 
            && !menuTrigger.contains(e.target)) 
        {
            dropdownMenu.classList.remove("show");
        }
    });

    if (logoutBtn) {
        logoutBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
                await fetch('/logout', { method: 'POST' });
            } catch (err) {
                console.error("L·ªói logout");
            } finally {
                sessionStorage.clear();
                window.location.reload();
            }
        });
    }
}
</script>

  </body>
</html>
