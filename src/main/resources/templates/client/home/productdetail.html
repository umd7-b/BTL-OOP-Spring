<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title th:text="${sanPham.tenSp} + ' ‚Äì Lowtech Store'">Chi ti·∫øt s·∫£n ph·∫©m</title>
    <link th:href="@{/client/css/home/index.css}" rel="stylesheet" />
    <link th:href="@{/client/css/home/productdetail.css}" rel="stylesheet" />
</head>

<body>
    <!-- TOPBAR -->
    <div class="topbar">
        Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn ƒë∆°n t·ª´ 599k ‚Ä¢ ƒê·ªïi size trong 7 ng√†y ‚Ä¢ Hotline: 0988 888 888
    </div>

    <!-- HEADER -->
    <header>
        <div class="header-inner">
            <a class="logo" href="/" aria-label="Trang ch·ªß" 
               style="display: flex; align-items: center; text-decoration: none;">
                <img th:src="@{/client/images/logo.png}" 
                     alt="Lowtech Store Logo" 
                     style="height: 40px; width: 40px; border-radius: 50%; object-fit: cover;" />
                <span style="font-size: 16px; font-weight: bold; margin-left: 10px; color: #000;">
                    Lowtech Store
                </span>
            </a>

            <div class="search" role="search">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                     stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <circle cx="11" cy="11" r="8"></circle>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                <input id="searchInput" placeholder="T√¨m gi√†y, √°o ƒë·∫•u, ph·ª• ki·ªán‚Ä¶ (v√≠ d·ª•: futsal, mercurial)" />
                <button class="btn-primary" id="searchBtn">T√¨m</button>
            </div>

            <div class="header-actions">
                <div class="hotline">üìû 0988 888 888</div>
                <button class="icon-btn" id="openCart" aria-label="M·ªü gi·ªè h√†ng">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" 
                         stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                        <circle cx="9" cy="21" r="1"></circle>
                        <circle cx="20" cy="21" r="1"></circle>
                        <path d="M1 1h4l2.68 12.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                    </svg>
                    <span id="cartCount">0</span>
                </button>
                <div id="loginBtn" class="login-icon">
                    <img src="https://th.bing.com/th/id/R.f58bd7f73934e1145c97570943087ec6?rik=41HmRGohn%2fnBJg&riu=http%3a%2f%2fwww.acsoft.vn%3a8081%2fresources%2fimages%2favatar.jpg&ehk=4oftGWjeo8XsGu%2fcHG2dUJubsKryVLuNa58H9D3TNKA%3d&risl=&pid=ImgRaw&r=0"
                         alt="user" />
                    <span class="notify-dot"></span>
                </div>
            </div>
        </div>

        <!-- NAVIGATION -->
        <nav class="nav" aria-label="Danh m·ª•c">
            <div class="nav-inner">
                <div class="dropdown">
                    <a href="#" id="tatCaBtn">T·∫§T C·∫¢</a>
                    <ul id="tatCaList" class="dropdown-content"></ul>
                </div>
                <div class="dropdown">
                    <a href="#" id="thuongHieuBtn">TH∆Ø∆†NG HI·ªÜU</a>
                    <ul id="thuongHieuList" class="dropdown-content"></ul>
                </div>
                <div class="dropdown">
                    <a href="#" id="monTheThaoBtn">M√îN TH·ªÇ THAO</a>
                    <ul id="monTheThaoList" class="dropdown-content"></ul>
                </div>
            </div>
        </nav>
    </header>

    <!-- TOOLBAR -->
    <div class="toolbar" id="toolbar">
        <div class="filters">
            <button class="chip active" data-chip="all">T·∫•t c·∫£</button>
            <button class="chip" data-chip="sale">ƒêang gi·∫£m gi√°</button>
            <button class="chip" data-chip="moi">H√†ng m·ªõi</button>
            <button class="chip" data-chip="<1000">D∆∞·ªõi 1tri·ªáu</button>
            <button class="chip" data-chip=">=1000">T·ª´ 1tri·ªáu</button>
        </div>
        <select class="sort" id="sortSelect" aria-label="S·∫Øp x·∫øp">
            <option value="popular">Ph·ªï bi·∫øn</option>
            <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
            <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
            <option value="newest">M·ªõi nh·∫•t</option>
        </select>
    </div>

    <!-- PH·∫¶N CHI TI·∫æT S·∫¢N PH·∫®M -->
    <section class="product-detail-section">
        <div class="container product-detail">
            <div class="left">
                <div class="main-image">
    <img th:src="@{${(sanPham.danhSachAnh != null AND !#lists.isEmpty(sanPham.danhSachAnh)) 
        ? '/uploads/products/' + sanPham.danhSachAnh[0].linkAnh 
        : '/client/images/no-image.png'}}"
         alt="·∫¢nh s·∫£n ph·∫©m"
         id="mainProductImage"> 
</div>
                    <div class="thumbs">
            <img th:each="anh : ${sanPham.danhSachAnh}"
                th:src="${'/uploads/products/' + anh.linkAnh}"
                alt="·∫¢nh ph·ª•" />
        </div>
            </div>

            <div class="right">
                <h1 th:text="${sanPham.tenSp}">T√™n s·∫£n ph·∫©m</h1>
                <div class="price">
                    <span class="new" 
                          th:text="${#numbers.formatDecimal(sanPham.giaKm != null ? sanPham.giaKm : sanPham.giaGoc, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">
                          0‚Ç´
                    </span>
                    <span class="old"
                          th:if="${sanPham.giaKm != null && sanPham.giaKm < sanPham.giaGoc}"
                          th:text="${#numbers.formatDecimal(sanPham.giaGoc, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">
                          Gi√° c≈©
                    </span>
                </div>

                <p th:text="${sanPham.moTa}">M√¥ t·∫£ s·∫£n ph·∫©m</p>

                <div class="quantity">
                    <label for="qty">S·ªë l∆∞·ª£ng:</label>
                    <input id="qty" type="number" min="1" value="1">
                </div>
                <div class="product-options">
    <label>Ph√¢n lo·∫°i:</label>
    
    <div class="variant-options"> 
        <button th:each="bt : ${sanPham.bienThe}"
            
            th:if="${bt.mauSac != null AND bt.kichThuoc != null}"
            
            th:text="${bt.mauSac} + ' - ' + ${bt.kichThuoc}"
            
            class="variant-btn" type="button"></button>
    </div>
</div>

                
                </div>

                <div class="actions">
                    <button class="btn-primary">üõí Th√™m v√†o gi·ªè h√†ng</button>
                    <button class="btn-outline">Mua ngay</button>
                </div>
            </div>
        </div>  
    </section>

    <!-- FOOTER -->
    <footer>
        <div class="footer-inner">
            <div class="ft-col">
                <h4>LT SPORT STORE</h4>
                <p>H·ªá th·ªëng c·ª≠a h√†ng ƒë·ªì th·ªÉ thao ‚Äì chuy√™n gi√†y, √°o ƒë·∫•u & ph·ª• ki·ªán. Cam k·∫øt ch√≠nh h√£ng, ƒë·ªïi size trong 7 ng√†y.</p>
                <div class="newsletter">
                    <input placeholder="Nh·∫≠p email ƒë·ªÉ nh·∫≠n ∆∞u ƒë√£i" />
                    <button class="btn-primary">ƒêƒÉng k√Ω</button>
                </div>
            </div>
            <div class="ft-col">
                <h4>Li√™n h·ªá</h4>
                <p>Hotline: 0988 888 888<br />Email: support@LTStore.vn<br />CSKH: 8:00 ‚Äì 22:00</p>
            </div>
            <div class="ft-col">
                <h4>Ch√≠nh s√°ch</h4>
                <p>Giao h√†ng & ƒê·ªïi tr·∫£<br />B·∫£o h√†nh & H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng<br />Thanh to√°n & B·∫£o m·∫≠t</p>
            </div>
        </div>
    </footer>

    <!-- CART DRAWER -->
    <aside class="cart-drawer" id="cartDrawer" aria-label="Gi·ªè h√†ng" aria-hidden="true">
        <div class="cart-head" style="display: flex; justify-content: space-between; align-items: center;">
            <strong>Gi·ªè h√†ng</strong>
            <button class="btn-outline" id="closeCart">ƒê√≥ng</button>
        </div>
        <div class="cart-items" id="cartItems"></div>
        <div class="cart-foot">
            <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                <span>T·∫°m t√≠nh</span>
                <strong id="subtotal">0‚Ç´</strong>
            </div>
            <button class="btn-primary" style="width: 100%" id="checkoutBtn">Thanh to√°n</button>
        </div>
    </aside>

    <!-- JAVASCRIPT -->
    <script th:src="@{/client/js/home/index.js}" defer></script>
    
    <!-- SCRIPT ƒêƒÇNG NH·∫¨P/ƒêƒÇNG XU·∫§T -->
    <script>
    // --- B·∫Øt ƒë·∫ßu 1 DOMContentLoaded duy nh·∫•t ---
    document.addEventListener("DOMContentLoaded", async function () {
        
        // --- 1. Ch·∫°y logic Auth (ƒêƒÉng nh·∫≠p) ---
        try {
            const response = await fetch('/api/auth/me');

            if (response.ok) {
                const user = await response.json();
                const hoTen = user.hoTen || user.ho_ten;

                if (!hoTen) {
                    console.error("Kh√¥ng t√¨m th·∫•y 'hoTen' trong user object:", user);
                    sessionStorage.clear();
                    renderLoginButton();
                } else {
                    sessionStorage.setItem("username", user.tenDangNhap || user.username);
                    sessionStorage.setItem("ho_ten", hoTen);
                    renderUserMenu(hoTen);
                }
            } else {
                sessionStorage.clear();
                renderLoginButton();
            }
        } catch (error) {
            console.error("Kh√¥ng th·ªÉ k·∫øt n·ªëi server:", error);
            sessionStorage.clear();
            renderLoginButton();
        }

        // --- 2. Ch·∫°y logic ƒë·ªïi ·∫£nh ---
       setTimeout(() => {
        const mainImage = document.getElementById("mainProductImage");
        const thumbnails = document.querySelectorAll(".thumbs img");

        console.log("Main image:", mainImage); // Debug
        console.log("Thumbnails found:", thumbnails.length); // Debug

        if (mainImage && thumbnails.length > 0) {
            
            // L√†m n·ªïi b·∫≠t ·∫£nh nh·ªè ƒë·∫ßu ti√™n
            thumbnails[0].classList.add("active");

            // G·∫Øn s·ª± ki·ªán click cho c√°c ·∫£nh nh·ªè
            thumbnails.forEach((thumb, index) => {
                thumb.style.cursor = "pointer"; // Th√™m cursor pointer
                
                thumb.addEventListener("click", function() {
                    console.log("Clicked thumbnail:", index); // Debug
                    
                    const newSrc = this.getAttribute("src");
                    console.log("New src:", newSrc); // Debug
                    
                    // ƒê·ªïi ·∫£nh to
                    mainImage.src = newSrc;

                    // C·∫≠p nh·∫≠t vi·ªÅn 'active'
                    thumbnails.forEach(t => t.classList.remove("active"));
                    this.classList.add("active");
                });
            });
        } else {
            console.warn("Kh√¥ng t√¨m th·∫•y ·∫£nh ch√≠nh ho·∫∑c ·∫£nh thumbnail!");
        }
    }, 100);
    }); 
    // --- K·∫øt th√∫c DOMContentLoaded ---


    // ===========================================
    // --- C√ÅC H√ÄM H·ªñ TR·ª¢ (ƒê·ªÉ b√™n ngo√†i) ---
    // ===========================================

    // H√†m v·∫Ω menu user
    function renderUserMenu(hoTen) {
        const loginBtn = document.getElementById("loginBtn");
        if (!loginBtn) return;

        loginBtn.outerHTML = `
            <div class="user-menu-container">
                <div id="userMenuTrigger" class="user-menu-trigger">
                    <span>üë§ Xin ch√†o, <strong>${hoTen}</strong></span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div id="userDropdownMenu" class="dropdown-menu">
                    <a href="/profile">Th√¥ng tin c√° nh√¢n</a>
                    <a href="/cart">Gi·ªè h√†ng</a>
                    <a href="#" id="logoutBtn">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>`;
        addMenuListeners();
    }

    // H√†m render n√∫t login
    function renderLoginButton() {
        const menuContainer = document.querySelector(".user-menu-container");

        if (menuContainer) {
            menuContainer.outerHTML = `
                <div id="loginBtn" class="login-icon">
                    <img src="https://th.bing.com/th/id/R.f58bd7f73934e1145c97570943087ec6?rik=41HmRGohn%2fnBJg&riu=http%3a%2f%2fwww.acsoft.vn%3a8081%2fresources%2fimages%2favatar.jpg&ehk=4oftGWjeo8XsGu%2fcHG2dUJubsKryVLuNa58H9D3TNKA%3d&risl=&pid=ImgRaw&r=0"
                         alt="user" />
                    <span class="notify-dot"></span>
                </div>`;
        }
        
        const loginBtn = document.getElementById("loginBtn");
        if (loginBtn) {
            // X√≥a listener c≈© (n·∫øu c√≥) v√† th√™m listener m·ªõi
            const newLoginBtn = loginBtn.cloneNode(true);
            if (loginBtn.parentNode) {
                loginBtn.parentNode.replaceChild(newLoginBtn, loginBtn);
            }
            
            newLoginBtn.addEventListener("click", () => {
                window.location.href = "/login";
            });
        }
    }

    // G·∫Øn event listeners cho menu
    function addMenuListeners() {
        const menuTrigger = document.getElementById("userMenuTrigger");
        const dropdownMenu = document.getElementById("userDropdownMenu");
        const logoutBtn = document.getElementById("logoutBtn");

        if (menuTrigger && dropdownMenu) {
            menuTrigger.addEventListener("click", (event) => {
                event.stopPropagation();
                dropdownMenu.classList.toggle("show");
            });
        }

        window.addEventListener("click", (e) => {
            if (menuTrigger && dropdownMenu && dropdownMenu.classList.contains("show") && !menuTrigger.contains(e.target)) {
                dropdownMenu.classList.remove("show");
            }
        });

        if (logoutBtn) {
            logoutBtn.addEventListener("click", async (e) => {
                e.preventDefault();
                try {
                    await fetch('/logout', { method: 'POST' }); 
                } catch (err) {
                    console.error("L·ªói logout:", err);
                } finally {
                    sessionStorage.clear();
                    window.location.reload();
                }
            });
        }
    }
</script>

  
</body>
</htm